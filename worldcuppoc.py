# -*- coding: utf-8 -*-
"""WorldcUPPOC.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1REmqeGNYW7Qc-TY672T6fFvh2edeQISc
"""

!pip install pyspark

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.model_selection import train_test_split, cross_val_score
from sklearn.preprocessing import LabelEncoder
from sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix
import warnings
warnings.filterwarnings('ignore')

# Set style for visualizations
sns.set_style("whitegrid")
plt.rcParams['figure.figsize'] = (12, 6)

print("‚úì Libraries imported successfully")

# STEP 2: Load and Prepare Data
# ============================================


# Load the CSV file (replace 'your_file.csv' with your actual filename)
df = pd.read_csv('cwc20data.csv')

# OR if you know the filename, just use:
# df = pd.read_csv('cwc_spreadsheet.csv')

print("\n" + "="*50)
print("EXPLORATORY DATA ANALYSIS")
print("="*50)

# Basic statistics
print("\nDataset Info:")
print(df.info())

print("\nMissing values:")
print(df.isnull().sum())

# Remove the row with 'None' as winner (id=11)
df = df[df['Match_winner'] != 'None'].reset_index(drop=True)

# Remove rows with NaN values in critical columns
df = df.dropna(subset=['Team1', 'Team2', 'Match_winner'])
print(f"\n‚úì Removed matches with no winner or missing team data. New shape: {df.shape}")

# IMPORTANT: Standardize column names by replacing spaces with underscores
df.columns = df.columns.str.replace(' ', '_')
print("\n‚úì Standardized column names")

# CRITICAL: Clean all text columns to remove extra spaces and standardize formatting
text_columns = ['Team1', 'Team2', 'Match_winner', 'city', 'venue']
for col in text_columns:
    if col in df.columns:
        df[col] = df[col].str.strip()  # Remove leading/trailing spaces

print("\n‚úì Cleaned text data (removed extra spaces)")

# Check for any remaining duplicates in team names
print("\nUnique teams after cleaning:")
all_teams = pd.concat([df['Team1'], df['Team2'], df['Match_winner']]).dropna().unique()
print(f"Total unique teams: {len(all_teams)}")
print(sorted(all_teams))

# Tournament-wise analysis
print("\nMatches per tournament:")
tournament_analysis = df['year'].value_counts().sort_index().reset_index()
tournament_analysis.columns = ['Year', 'Number_of_Matches']
print(tournament_analysis)

# Winner analysis
print("\nTop winning teams:")
winner_analysis = df['Match_winner'].value_counts().head(10).reset_index()
winner_analysis.columns = ['Team', 'Total_Wins']
print(winner_analysis)

# Condition analysis
print("\nMatches by pitch conditions:")
condition_analysis = df['Primary_Conditions'].value_counts().reset_index()
condition_analysis.columns = ['Condition', 'Number_of_Matches']
print(condition_analysis)

# ============================================
# EXPORT EDA RESULTS TO CSV FOR POWER BI
# ============================================

print("\n" + "="*50)
print("EXPORTING EDA RESULTS FOR POWER BI")
print("="*50)

# 1. Tournament-wise match count
tournament_analysis.to_csv('eda_tournament_analysis.csv', index=False)
print("‚úì Exported: eda_tournament_analysis.csv")

# 2. Top winning teams
winner_analysis.to_csv('eda_winner_analysis.csv', index=False)
print("‚úì Exported: eda_winner_analysis.csv")

# 3. Matches by pitch conditions
condition_analysis.to_csv('eda_condition_analysis.csv', index=False)
print("‚úì Exported: eda_condition_analysis.csv")

# 4. Wins by year and team (for trend analysis)
wins_by_year_team = df.groupby(['year', 'Match_winner']).size().reset_index(name='Wins')
wins_by_year_team.columns = ['Year', 'Team', 'Wins']
wins_by_year_team.to_csv('eda_wins_by_year_team.csv', index=False)
print("‚úì Exported: eda_wins_by_year_team.csv")

# 5. Wins by condition and team
wins_by_condition_team = df.groupby(['Primary_Conditions', 'Match_winner']).size().reset_index(name='Wins')
wins_by_condition_team.columns = ['Condition', 'Team', 'Wins']
wins_by_condition_team.to_csv('eda_wins_by_condition_team.csv', index=False)
print("‚úì Exported: eda_wins_by_condition_team.csv")

# 6. City-wise match distribution
city_analysis = df['city'].value_counts().reset_index()
city_analysis.columns = ['City', 'Number_of_Matches']
city_analysis.to_csv('eda_city_analysis.csv', index=False)
print("‚úì Exported: eda_city_analysis.csv")

# 7. Venue-wise match distribution
venue_analysis = df.groupby(['city', 'venue']).size().reset_index(name='Number_of_Matches')
venue_analysis.to_csv('eda_venue_analysis.csv', index=False)
print("‚úì Exported: eda_venue_analysis.csv")

# 8. Team win rate by condition (percentage)
team_condition_stats = df.groupby(['Match_winner', 'Primary_Conditions']).size().reset_index(name='Wins')
team_total_matches = df.groupby('Match_winner').size().reset_index(name='Total_Matches')
team_condition_stats = team_condition_stats.merge(team_total_matches, left_on='Match_winner', right_on='Match_winner')
team_condition_stats['Win_Rate_Percentage'] = (team_condition_stats['Wins'] / team_condition_stats['Total_Matches'] * 100).round(2)
team_condition_stats.columns = ['Team', 'Condition', 'Wins', 'Total_Matches', 'Win_Rate_Percentage']
team_condition_stats.to_csv('eda_team_condition_win_rates.csv', index=False)
print("‚úì Exported: eda_team_condition_win_rates.csv")

# 9. Summary statistics
summary_stats = pd.DataFrame({
    'Metric': [
        'Total Matches',
        'Total Teams',
        'Total Cities',
        'Total Venues',
        'Years Covered',
        'Most Common Condition',
        'Top Winning Team',
        'Average Matches per Year'
    ],
    'Value': [
        len(df),
        len(all_teams),
        df['city'].nunique(),
        df['venue'].nunique(),
        df['year'].nunique(),
        df['Primary_Conditions'].mode()[0],
        df['Match_winner'].mode()[0],
        round(len(df) / df['year'].nunique(), 1)
    ]
})
summary_stats.to_csv('eda_summary_statistics.csv', index=False)
print("‚úì Exported: eda_summary_statistics.csv")

print("\n" + "="*50)
print("‚úì ALL EDA RESULTS EXPORTED SUCCESSFULLY!")
print("="*50)
print("\nFiles created for Power BI:")
print("1. eda_tournament_analysis.csv - Matches per tournament")
print("2. eda_winner_analysis.csv - Top winning teams")
print("3. eda_condition_analysis.csv - Matches by pitch conditions")
print("4. eda_wins_by_year_team.csv - Yearly win trends by team")
print("5. eda_wins_by_condition_team.csv - Wins by condition and team")
print("6. eda_city_analysis.csv - City-wise match distribution")
print("7. eda_venue_analysis.csv - Venue-wise match distribution")
print("8. eda_team_condition_win_rates.csv - Team performance by condition")
print("9. eda_summary_statistics.csv - Overall summary metrics")

print("\n" + "="*50)
print("GENERATING VISUALIZATIONS")
print("="*50)

# 1. Wins by team
plt.figure(figsize=(14, 6))
wins_by_team = df['Match_winner'].value_counts().head(15)
sns.barplot(x=wins_by_team.values, y=wins_by_team.index, palette='viridis')
plt.title('Top 15 Teams by Number of Wins', fontsize=16, fontweight='bold')
plt.xlabel('Number of Wins', fontsize=12)
plt.ylabel('Team', fontsize=12)
plt.tight_layout()
plt.savefig('wins_by_team.png', dpi=300, bbox_inches='tight')
plt.show()

# 2. Wins by conditions
plt.figure(figsize=(10, 6))
condition_wins = df.groupby(['Primary_Conditions', 'Match_winner']).size().reset_index(name='count')
top_teams = df['Match_winner'].value_counts().head(10).index
condition_wins_filtered = condition_wins[condition_wins['Match_winner'].isin(top_teams)]
pivot_data = condition_wins_filtered.pivot_table(
    values='count',
    index='Match_winner',
    columns='Primary_Conditions',
    fill_value=0
)
sns.heatmap(pivot_data, annot=True, fmt='g', cmap='YlOrRd', cbar_kws={'label': 'Wins'})
plt.title('Wins by Team and Pitch Conditions', fontsize=16, fontweight='bold')
plt.xlabel('Pitch Conditions', fontsize=12)
plt.ylabel('Team', fontsize=12)
plt.tight_layout()
plt.savefig('wins_by_conditions.png', dpi=300, bbox_inches='tight')
plt.show()

# 3. Tournament trends
plt.figure(figsize=(12, 6))
yearly_wins = df.groupby(['year', 'Match_winner']).size().reset_index(name='wins')
top_teams_year = df['Match_winner'].value_counts().head(8).index
yearly_wins_filtered = yearly_wins[yearly_wins['Match_winner'].isin(top_teams_year)]
for team in top_teams_year:
    team_data = yearly_wins_filtered[yearly_wins_filtered['Match_winner'] == team]
    plt.plot(team_data['year'], team_data['wins'], marker='o', label=team, linewidth=2)
plt.title('Team Performance Trends Across Tournaments', fontsize=16, fontweight='bold')
plt.xlabel('Year', fontsize=12)
plt.ylabel('Number of Wins', fontsize=12)
plt.legend(bbox_to_anchor=(1.05, 1), loc='upper left')
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.savefig('tournament_trends.png', dpi=300, bbox_inches='tight')
plt.show()

print("‚úì Visualizations saved")

print("\n" + "="*50)
print("FEATURE ENGINEERING")
print("="*50)

# Create features for each team
def create_team_features(df):
    features_df = df.copy()

    # Historical win rate for each team
    team_wins = df['Match_winner'].value_counts().to_dict()
    features_df['team1_total_wins'] = features_df['Team1'].map(team_wins).fillna(0)
    features_df['team2_total_wins'] = features_df['Team2'].map(team_wins).fillna(0)
     # Win rate by conditions
    for condition in df['Primary_Conditions'].unique():
        condition_wins = df[df['Primary_Conditions'] == condition]['Match_winner'].value_counts().to_dict()
        features_df[f'team1_wins_{condition}'] = features_df['Team1'].map(condition_wins).fillna(0)
        features_df[f'team2_wins_{condition}'] = features_df['Team2'].map(condition_wins).fillna(0)


    # Head to head record
    def get_h2h(row):
        h2h_df = df[((df['Team1'] == row['Team1']) & (df['Team2'] == row['Team2'])) |
                    ((df['Team1'] == row['Team2']) & (df['Team2'] == row['Team1']))]
        if len(h2h_df) == 0:
            return 0
        team1_wins = len(h2h_df[h2h_df['Match_winner'] == row['Team1']])
        return team1_wins / len(h2h_df)

    features_df['h2h_win_rate'] = features_df.apply(get_h2h, axis=1)

    # Recent form (last 5 matches)
    def get_recent_form(team, current_idx):
        team_matches = df[(df['Team1'] == team) | (df['Team2'] == team)]
        team_matches = team_matches[team_matches.index < current_idx].tail(5)
        if len(team_matches) == 0:
            return 0.5
        wins = len(team_matches[team_matches['Match_winner'] == team])
        return wins / len(team_matches)

    features_df['team1_recent_form'] = [get_recent_form(row['Team1'], idx)
                                         for idx, row in features_df.iterrows()]
    features_df['team2_recent_form'] = [get_recent_form(row['Team2'], idx)
                                         for idx, row in features_df.iterrows()]

    return features_df

features_df = create_team_features(df)
print("‚úì Features created successfully")
print(f"Total features: {features_df.shape[1]}")

print("\n" + "="*50)
print("PREPARING DATA FOR MACHINE LEARNING")
print("="*50)

# Encode categorical variables
le_team = LabelEncoder()
le_condition = LabelEncoder()
le_city = LabelEncoder()

# Fit encoders on all unique values
all_teams = pd.concat([features_df['Team1'], features_df['Team2']]).unique()
le_team.fit(all_teams)

features_df['Team1_encoded'] = le_team.transform(features_df['Team1'])
features_df['Team2_encoded'] = le_team.transform(features_df['Team2'])
features_df['city_encoded'] = le_city.fit_transform(features_df['city'])

# Target variable
features_df['target'] = (features_df['Match_winner'] == features_df['Team1']).astype(int)


# Select features for model (ONLY numeric/encoded columns)
feature_columns = [col for col in features_df.columns if col not in
                   ['id', 'city', 'venue', 'Team1', 'Team2', 'Primary Conditions',
                    'Match_winner', 'year', 'target']
                   and features_df[col].dtype in ['int64', 'float64']]

# Make sure we're only using numeric columns
print(f"Selected feature columns: {feature_columns}")

X = features_df[feature_columns]
y = features_df['target']

print(f"‚úì Features prepared")
print(f"Feature columns: {len(feature_columns)}")
print(f"Features: {feature_columns[:10]}...")  # Show first 10

print("\n" + "="*50)
print("TRAINING MACHINE LEARNING MODELS")
print("="*50)

# Split data
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

print(f"Training set size: {len(X_train)}")
print(f"Test set size: {len(X_test)}")

# Initialize models
models = {
    'Random Forest': RandomForestClassifier(n_estimators=200, max_depth=10, random_state=42),
    'Gradient Boosting': GradientBoostingClassifier(n_estimators=100, random_state=42),
    'Logistic Regression': LogisticRegression(max_iter=1000, random_state=42)
}

# Train and evaluate models
results = {}

for name, model in models.items():
    print(f"\n{'='*40}")
    print(f"Training {name}...")
    print(f"{'='*40}")

    # Train
    model.fit(X_train, y_train)

    # Predictions
    y_pred_train = model.predict(X_train)
    y_pred_test = model.predict(X_test)

    # Accuracy
    train_acc = accuracy_score(y_train, y_pred_train)
    test_acc = accuracy_score(y_test, y_pred_test)

    # Cross-validation
    cv_scores = cross_val_score(model, X_train, y_train, cv=5)

    results[name] = {
        'model': model,
        'train_accuracy': train_acc,
        'test_accuracy': test_acc,
        'cv_mean': cv_scores.mean(),
        'cv_std': cv_scores.std()
    }

    print(f"Training Accuracy: {train_acc:.4f}")
    print(f"Test Accuracy: {test_acc:.4f}")
    print(f"Cross-validation Score: {cv_scores.mean():.4f} (+/- {cv_scores.std():.4f})")

    # Classification report
    print(f"\nClassification Report:")
    print(classification_report(y_test, y_pred_test, target_names=['Team2 Wins', 'Team1 Wins']))

print("\n" + "="*50)
print("MODEL COMPARISON")
print("="*50)

# Create comparison dataframe
comparison_df = pd.DataFrame({
    'Model': list(results.keys()),
    'Train Accuracy': [results[m]['train_accuracy'] for m in results.keys()],
    'Test Accuracy': [results[m]['test_accuracy'] for m in results.keys()],
    'CV Mean': [results[m]['cv_mean'] for m in results.keys()],
    'CV Std': [results[m]['cv_std'] for m in results.keys()]
})

print(comparison_df.to_string(index=False))

# Visualize model comparison
plt.figure(figsize=(12, 6))
x = np.arange(len(comparison_df))
width = 0.25

plt.bar(x - width, comparison_df['Train Accuracy'], width, label='Train Accuracy', alpha=0.8)
plt.bar(x, comparison_df['Test Accuracy'], width, label='Test Accuracy', alpha=0.8)
plt.bar(x + width, comparison_df['CV Mean'], width, label='CV Mean', alpha=0.8)

plt.xlabel('Models', fontsize=12)
plt.ylabel('Accuracy', fontsize=12)
plt.title('Model Performance Comparison', fontsize=16, fontweight='bold')
plt.xticks(x, comparison_df['Model'])
plt.legend()
plt.ylim(0, 1)
plt.grid(True, alpha=0.3, axis='y')
plt.tight_layout()
plt.savefig('model_comparison.png', dpi=300, bbox_inches='tight')
plt.show()

# Select best model
best_model_name = comparison_df.loc[comparison_df['Test Accuracy'].idxmax(), 'Model']
best_model = results[best_model_name]['model']

print(f"\n‚úì Best Model: {best_model_name}")
print(f"Test Accuracy: {results[best_model_name]['test_accuracy']:.4f}")

print("\n" + "="*50)
print("FEATURE IMPORTANCE ANALYSIS")
print("="*50)

if hasattr(best_model, 'feature_importances_'):
    feature_importance = pd.DataFrame({
        'Feature': feature_columns,
        'Importance': best_model.feature_importances_
    }).sort_values('Importance', ascending=False)

    print("\nTop 15 Most Important Features:")
    print(feature_importance.head(15).to_string(index=False))

    # Plot feature importance
    plt.figure(figsize=(12, 8))
    top_features = feature_importance.head(20)
    sns.barplot(x='Importance', y='Feature', data=top_features, palette='rocket')
    plt.title('Top 20 Feature Importance', fontsize=16, fontweight='bold')
    plt.xlabel('Importance', fontsize=12)
    plt.ylabel('Feature', fontsize=12)
    plt.tight_layout()
    plt.savefig('feature_importance.png', dpi=300, bbox_inches='tight')
    plt.show()

print("\n" + "="*50)
print("CONFUSION MATRIX")
print("="*50)

y_pred_best = best_model.predict(X_test)
cm = confusion_matrix(y_test, y_pred_best)

plt.figure(figsize=(8, 6))
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues', cbar=True,
            xticklabels=['Team2 Wins', 'Team1 Wins'],
            yticklabels=['Team2 Wins', 'Team1 Wins'])
plt.title('Confusion Matrix - Best Model', fontsize=16, fontweight='bold')
plt.ylabel('Actual', fontsize=12)
plt.xlabel('Predicted', fontsize=12)
plt.tight_layout()
plt.savefig('confusion_matrix.png', dpi=300, bbox_inches='tight')
plt.show()

print("\n" + "="*50)
print("TEAM STRENGTH ANALYSIS FOR 2026")
print("="*50)

# Calculate comprehensive team statistics
def calculate_team_strength(df, team):
    stats = {}

    # Overall statistics
    team_matches = df[(df['Team1'] == team) | (df['Team2'] == team)]
    wins = len(df[df['Match_winner'] == team])
    total_matches = len(team_matches)

    stats['Total Wins'] = wins
    stats['Total Matches'] = total_matches
    stats['Win Rate'] = wins / total_matches if total_matches > 0 else 0

    # Recent form (2024 matches)
    recent_matches = df[(df['year'] == 2024) &
                        ((df['Team1'] == team) | (df['Team2'] == team))]
    recent_wins = len(recent_matches[recent_matches['Match_winner'] == team])
    stats['2024 Matches'] = len(recent_matches)
    stats['2024 Wins'] = recent_wins
    stats['2024 Win Rate'] = recent_wins / len(recent_matches) if len(recent_matches) > 0 else 0

    # Performance by conditions
    for condition in ['spin', 'pace', 'batting', 'balanced', 'bowling']:
        condition_matches = df[(df['Primary_Conditions'] == condition) &
                               ((df['Team1'] == team) | (df['Team2'] == team))]
        condition_wins = len(condition_matches[condition_matches['Match_winner'] == team])
        total_cond = len(condition_matches)
        stats[f'{condition.capitalize()} Win Rate'] = condition_wins / total_cond if total_cond > 0 else 0

    return stats

# Get all unique teams
all_teams_list = pd.concat([df['Team1'], df['Team2']]).unique()

# Calculate strength for each team
team_strengths = []
for team in all_teams_list:
    strength = calculate_team_strength(df, team)
    strength['Team'] = team
    team_strengths.append(strength)

team_strength_df = pd.DataFrame(team_strengths)

# Calculate composite strength score
team_strength_df['Composite Score'] = (
    team_strength_df['Win Rate'] * 0.3 +
    team_strength_df['2024 Win Rate'] * 0.4 +
    team_strength_df['Spin Win Rate'] * 0.1 +
    team_strength_df['Pace Win Rate'] * 0.1 +
    team_strength_df['Batting Win Rate'] * 0.05 +
    team_strength_df['Balanced Win Rate'] * 0.05
)

# Sort by composite score
team_strength_df = team_strength_df.sort_values('Composite Score', ascending=False)

print("\nTop 10 Teams by Composite Strength Score:")
print(team_strength_df[['Team', 'Win Rate', '2024 Win Rate', 'Composite Score']].head(10).to_string(index=False))

# ============================================
# EXPORT TEAM STRENGTH DATA FOR POWER BI
# ============================================

print("\n" + "="*50)
print("EXPORTING TEAM STRENGTH DATA FOR POWER BI")
print("="*50)

# 1. Full team strength analysis with all metrics
team_strength_df.to_csv('team_strength_2026.csv', index=False)
print("‚úì Exported: team_strength_2026.csv")

# 2. Top 15 teams only (for focused visualization)
top_15_teams = team_strength_df.head(15).copy()
top_15_teams.to_csv('team_strength_top15.csv', index=False)
print("‚úì Exported: team_strength_top15.csv")

# 3. Team rankings (with rank column)
team_rankings = team_strength_df[['Team', 'Composite Score', 'Win Rate', '2024 Win Rate']].copy()
team_rankings['Rank'] = range(1, len(team_rankings) + 1)
team_rankings = team_rankings[['Rank', 'Team', 'Composite Score', 'Win Rate', '2024 Win Rate']]
team_rankings.to_csv('team_rankings_2026.csv', index=False)
print("‚úì Exported: team_rankings_2026.csv")

# 4. Condition-specific performance matrix (unpivoted for Power BI)
condition_performance = []
for _, row in team_strength_df.iterrows():
    for condition in ['Spin', 'Pace', 'Batting', 'Balanced', 'Bowling']:
        condition_performance.append({
            'Team': row['Team'],
            'Condition': condition,
            'Win_Rate': row[f'{condition} Win Rate'],
            'Composite_Score': row['Composite Score']
        })

condition_performance_df = pd.DataFrame(condition_performance)
condition_performance_df.to_csv('team_condition_performance.csv', index=False)
print("‚úì Exported: team_condition_performance.csv")

# 5. 2024 Form analysis (recent performance focus)
form_2024 = team_strength_df[['Team', '2024 Matches', '2024 Wins', '2024 Win Rate', 'Composite Score']].copy()
form_2024 = form_2024[form_2024['2024 Matches'] > 0]  # Only teams that played in 2024
form_2024 = form_2024.sort_values('2024 Win Rate', ascending=False)
form_2024.to_csv('team_2024_form.csv', index=False)
print("‚úì Exported: team_2024_form.csv")

# 6. Summary statistics for dashboard cards
summary_metrics = pd.DataFrame({
    'Metric': [
        'Total Teams Analyzed',
        'Teams with 2024 Data',
        'Highest Composite Score',
        'Average Composite Score',
        'Highest Win Rate',
        'Average Win Rate',
        'Top Team',
        'Most Improved 2024'
    ],
    'Value': [
        len(team_strength_df),
        len(team_strength_df[team_strength_df['2024 Matches'] > 0]),
        round(team_strength_df['Composite Score'].max(), 4),
        round(team_strength_df['Composite Score'].mean(), 4),
        round(team_strength_df['Win Rate'].max(), 4),
        round(team_strength_df['Win Rate'].mean(), 4),
        team_strength_df.iloc[0]['Team'],
        form_2024.iloc[0]['Team'] if len(form_2024) > 0 else 'N/A'
    ]
})
summary_metrics.to_csv('team_strength_summary.csv', index=False)
print("‚úì Exported: team_strength_summary.csv")

print("\n" + "="*50)
print("‚úì ALL TEAM STRENGTH DATA EXPORTED!")
print("="*50)
print("\nFiles created for Power BI:")
print("1. team_strength_2026.csv - Complete team strength analysis")
print("2. team_strength_top15.csv - Top 15 teams only")
print("3. team_rankings_2026.csv - Teams with rank numbers")
print("4. team_condition_performance.csv - Performance by condition (unpivoted)")
print("5. team_2024_form.csv - Recent 2024 performance")
print("6. team_strength_summary.csv - Summary metrics for cards")

print("\n" + "="*50)
print("2026 T20 WORLD CUP WINNER PREDICTION")
print("="*50)

# Simulate potential matchups between top teams
top_teams_2026 = team_strength_df.head(12)['Team'].tolist()

print(f"\nTop contenders for 2026: {', '.join(top_teams_2026[:8])}")

# Initialize and fit label encoders (if not already done)
if 'le_team' not in locals() or not hasattr(le_team, 'classes_'):
    from sklearn.preprocessing import LabelEncoder
    le_team = LabelEncoder()
    le_team.fit(df['Team1'].tolist() + df['Team2'].tolist())

if 'le_condition' not in locals() or not hasattr(le_condition, 'classes_'):
    le_condition = LabelEncoder()
    le_condition.fit(df['Primary_Conditions'].unique())

# Predict outcomes for top teams against each other
def predict_match(team1, team2, condition='balanced'):
    # Check if teams are in the encoder's classes
    if team1 not in le_team.classes_ or team2 not in le_team.classes_:
        print(f"Warning: {team1} or {team2} not in training data")
        return team1, 0.5  # Default prediction

    # Create feature row
    match_data = {
        'Team1_encoded': le_team.transform([team1])[0],
        'Team2_encoded': le_team.transform([team2])[0],
        'Primary_Conditions_encoded': le_condition.transform([condition])[0],
        'team1_total_wins': df[df['Match_winner'] == team1].shape[0],
        'team2_total_wins': df[df['Match_winner'] == team2].shape[0],
    }

    # Add condition-specific wins
    for cond in df['Primary_Conditions'].unique():
        match_data[f'team1_wins_{cond}'] = df[(df['Primary_Conditions'] == cond) &
                                                (df['Match_winner'] == team1)].shape[0]
        match_data[f'team2_wins_{cond}'] = df[(df['Primary_Conditions'] == cond) &
                                                (df['Match_winner'] == team2)].shape[0]

    # H2H and recent form
    h2h_matches = df[((df['Team1'] == team1) & (df['Team2'] == team2)) |
                     ((df['Team1'] == team2) & (df['Team2'] == team1))]
    match_data['h2h_win_rate'] = len(h2h_matches[h2h_matches['Match_winner'] == team1]) / len(h2h_matches) if len(h2h_matches) > 0 else 0.5

    recent_team1 = df[(df['Team1'] == team1) | (df['Team2'] == team1)].tail(5)
    match_data['team1_recent_form'] = len(recent_team1[recent_team1['Match_winner'] == team1]) / len(recent_team1) if len(recent_team1) > 0 else 0.5

    recent_team2 = df[(df['Team1'] == team2) | (df['Team2'] == team2)].tail(5)
    match_data['team2_recent_form'] = len(recent_team2[recent_team2['Match_winner'] == team2]) / len(recent_team2) if len(recent_team2) > 0 else 0.5

    # Fill missing features with 0
    for col in feature_columns:
        if col not in match_data:
            match_data[col] = 0

    # Create dataframe and predict
    match_df = pd.DataFrame([match_data])
    match_df = match_df[feature_columns]

    prediction = best_model.predict(match_df)[0]
    probability = best_model.predict_proba(match_df)[0]

    winner = team1 if prediction == 1 else team2
    confidence = max(probability)

    return winner, confidence

# Simulate tournament
print("\n" + "="*50)
print("SIMULATING KEY MATCHUPS")
print("="*50)

wins_simulation = {team: 0 for team in top_teams_2026[:8]}

# Simulate matches between top 8 teams
for i, team1 in enumerate(top_teams_2026[:8]):
    for team2 in top_teams_2026[i+1:8]:
        winner, conf = predict_match(team1, team2, 'balanced')
        wins_simulation[winner] += 1
        print(f"{team1:20s} vs {team2:20s} ‚Üí Winner: {winner:15s} (Confidence: {conf:.2%})")

print("\n" + "="*50)
print("TOURNAMENT SIMULATION RESULTS")
print("="*50)

wins_df = pd.DataFrame(list(wins_simulation.items()), columns=['Team', 'Predicted Wins'])
wins_df = wins_df.sort_values('Predicted Wins', ascending=False)

print("\nPredicted wins in head-to-head matchups:")
print(wins_df.to_string(index=False))

# Final prediction
predicted_winner = wins_df.iloc[0]['Team']
predicted_runner_up = wins_df.iloc[1]['Team']

print("\n" + "="*50)
print("üèÜ FINAL PREDICTION FOR 2026 T20 WORLD CUP üèÜ")
print("="*50)
print(f"\nü•á WINNER: {predicted_winner}")
print(f"ü•à RUNNER-UP: {predicted_runner_up}")
print(f"ü•â SEMI-FINALISTS: {wins_df.iloc[2]['Team']}, {wins_df.iloc[3]['Team']}")

# Visualize predictions
plt.figure(figsize=(12, 7))
plt.barh(range(len(wins_df)), wins_df['Predicted Wins'], color=['gold', 'silver', 'chocolate'] + ['steelblue']*(len(wins_df)-3))
plt.yticks(range(len(wins_df)), wins_df['Team'])
plt.xlabel('Predicted Wins in Simulated Matchups', fontsize=12)
plt.ylabel('Team', fontsize=12)
plt.title('2026 T20 World Cup - Predicted Tournament Performance', fontsize=16, fontweight='bold')
plt.gca().invert_yaxis()
plt.grid(True, alpha=0.3, axis='x')
plt.tight_layout()
plt.savefig('2026_prediction.png', dpi=300, bbox_inches='tight')
plt.show()